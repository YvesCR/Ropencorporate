---
title: "Description of query"
author: "YCR"
date: "14 March 2016"
output: html_document
---

Exemple of rmd report to easily have a look at the result of an oc query.

## Initialisation

First thing first, let's load the data and set up the session.

```{r echo=FALSE}
# library
library(data.table)
library(xtable)
library(stringr)
suppressWarnings(library(DT)) # install.packages("DT")
library(leaflet) # install.packages("leaflet")
# library(ggmap)
# suppressWarnings(suppressPackageStartupMessages(library(googleVis))) # install.packages("googleVis")

# path
path <- "C:/YCR Perso/opencorporates/"

# load the files
load(file = paste0(path, "DATA/Open_Corporates_dt_edf_20160314.rda")) # oc.dt

fingerprint.func <- function(x)  paste(sort(str_split(gsub("[[:punct:]]|[[:cntrl:]]", "", iconv(str_trim(tolower(x)))), " ")[[1]]), collapse = " ")


# Deal with the small differences between the names:

# oc.dt[, name2 := str_trim(tolower(name))]

# x <- "128 edf, ll"
fingerprint.func <- function(x)  paste(sort(str_split(gsub("[[:punct:]]|[[:cntrl:]]", "", str_trim(tolower(x))), " ")[[1]]), collapse = " ")

#  lapply(oc.dt[1:10, name2], fingerprint.func)

oc.dt[, name2 := unlist(lapply(name, fingerprint.func))]
### What I want: the most frequent occurence of the name

oc.dt[, .N, by = "name2"] # 392
oc.dt[, .N, by = "name"] # 432
# Taking the fingerprint reduce the number of company names by 10 %
# Good enough.

# Now, replace name2 by the top name appearing in term of number, then by the first appearing.
oc.dt[, freq.name := .N, by = "name"]
oc.dt[, freq.name2 := max(freq.name), by = "name2"]
# for a subset, select the top name
oc.dt[, name.up := name[max(which(freq.name2 == freq.name))], by = "name2"]
## seems to work.

#delete unused rows:
oc.dt[, freq.name := NULL]
oc.dt[, freq.name2 := NULL]
oc.dt[, name2 := NULL]

# oc.dt[, .N, by = "name"] # 432
# oc.dt[, .N, by = "name.up"] # 392

write.csv(oc.dt, file = paste0(path, "DATA/oc_dt.csv"))
```

## Basic overview

Now, let's have a look at the result of the query:
Number of different companies which have the term, places where the term is the more common, etc..

__Occurences of the name in the gazettes__

```{r results='asis', echo=FALSE}
num.oc <- dim(oc.dt)[1]
datatable(oc.dt[, list(Frequency = .N, Percentage = sprintf("%.1f%%", .N / num.oc * 100)), by = "name.up"][order(Frequency, decreasing = T)], options = list(pageLength = 10))
```

__Occurences of the juridictions__

```{r echo=FALSE}
datatable(oc.dt[, list(Frequency = .N, Percentage = sprintf("%.1f%%", .N / num.oc * 100)), by = "jurisdiction.code"][order(Frequency, decreasing = T)], options = list(pageLength = 10))
```

__Most recent apparition__

```{r results='asis', echo=FALSE}
datatable(oc.dt[, list(Frequency = .N, Percentage = sprintf("%.1f%%", .N / num.oc * 100)), by = "jurisdiction.code"][order(Frequency, decreasing = T)], options = list(pageLength = 10))
```

__Current status__

```{r results='asis', echo=FALSE}
datatable(oc.dt[, list(Frequency = .N, Percentage = sprintf("%.1f%%", .N / num.oc * 100)), by = "current.status"][order(Frequency, decreasing = T)], options = list(pageLength = 10))
```

__Inactive__

```{r results='asis', echo=FALSE}
datatable(oc.dt[, list(Frequency = .N, Percentage = sprintf("%.1f%%", .N / num.oc * 100)), by = "inactive"][order(Frequency, decreasing = T)], options = list(pageLength = 10))
```

__Branch status__

```{r results='asis', echo=FALSE}
datatable(oc.dt[, list(Frequency = .N, Percentage = sprintf("%.1f%%", .N / num.oc * 100)), by = c("branch.status")][order(Frequency, decreasing = T)], options = list(pageLength = 10))
```

__Company type__

```{r results='asis', echo=FALSE}
datatable(oc.dt[, list(Frequency = .N, Percentage = sprintf("%.1f%%", .N / num.oc * 100)), by = "company.type"][order(Frequency, decreasing = T)], options = list(pageLength = 10))
```

__Put the places on a leaflet map + link to the gazette + details__

```{r results='asis', echo=FALSE}

## create a table with the coordinate of each country and us and ca states:

# In datasets, the informations on the US states could be found.

us.states.df <- data.frame(abb = paste0("us_", str_trim(tolower(state.abb)))
                           , lat = state.center$y
                           , lng = state.center$x
                           , state.name = state.name)

ca.states.df <- data.frame(abb = paste0("ca_", c("nl"))
                           , lat = c(0)
                           , lng = c(0)
                           , state.name =  c("number?"))

row.states.df <- data.frame(abb = c("nb")
                           , lat = c(0)
                           , lng = c(0)
                           , state.name =  c("number?"))

world.states <- rbindlist(list(us.states.df, ca.states.df, row.states.df))
setnames(world.states, "abb", "jurisdiction.code")

# Point to map:
# For each place, a number follow by the concatenation of the gazettes links:

display <- oc.dt[, list(frequency = .N, display = paste(.N, " links here:\n <a href='", paste0(opencorporates.url, "'>", name.up, collapse = "</a>\n"), "</a>\n")), by = "jurisdiction.code"]

display.center <- merge(display, world.states, all.x = T, by = "jurisdiction.code")

display.center.us <- display.center[!is.na(display) & !is.na(lat)]

# Creation of the final map:
## Number of companies per country / states
## + set of link to click to:
# 
# # popup version
# map.leaflet <- leaflet() %>% addTiles() %>%  addPopups(display.center.us$lng, display.center.us$lat, display.center.us$display,
#     options = popupOptions(closeButton = TRUE))
# map.leaflet


# popup version
map.leaflet <- leaflet() %>% addTiles() %>%  addMarkers(display.center.us$lng, display.center.us$lat, display.center.us$display,
    options = popupOptions(closeButton = FALSE))
map.leaflet

```

__D3 link of the companies when a link appear among them_

```{r}
# which kind of link could be done?
# 


```

__Time series of the companies to represent the number of gazettes found over time__


